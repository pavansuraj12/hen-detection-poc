<!DOCTYPE html>
<html>
<head>
  <title>Hen Detection â€“ CCTV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      background: #111;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 10px;
    }
    .camera-box {
      position: relative;
      width: 416px;
      height: 416px;
      margin: auto;
      border: 2px solid #444;
    }
    video, canvas {
      position: absolute;
      width: 416px;
      height: 416px;
      top: 0;
      left: 0;
    }
    button {
      margin: 6px;
      padding: 10px 16px;
    }
    #status {
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>

<body>

<h3>Hen Detection (CCTV Debug)</h3>

<div class="camera-box">
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>
</div>

<button id="startBtn">Start</button>
<button id="stopBtn">Stop</button>

<div id="status">Page loaded</div>

<script>
console.log("JS loaded");

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusText = document.getElementById("status");

const SIZE = 416;
const SEND_INTERVAL = 300;
const HOLD_TIME = 800;

let timer = null;
let lastDetections = [];
let lastUpdate = performance.now();

document.getElementById("startBtn").onclick = startLive;
document.getElementById("stopBtn").onclick = stopLive;

async function startLive() {
  try {
    statusText.innerText = "Requesting camera...";
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } }
    });
    video.srcObject = stream;

    video.onloadedmetadata = () => {
      canvas.width = SIZE;
      canvas.height = SIZE;
      timer = setInterval(sendFrame, SEND_INTERVAL);
      statusText.innerText = "Live";
    };
  } catch (e) {
    console.error(e);
    statusText.innerText = "Camera error: " + e.message;
  }
}

function stopLive() {
  clearInterval(timer);
  timer = null;
  if (video.srcObject) {
    video.srcObject.getTracks().forEach(t => t.stop());
    video.srcObject = null;
  }
  ctx.clearRect(0,0,SIZE,SIZE);
  lastDetections = [];
  statusText.innerText = "Stopped";
}

function sendFrame() {
  ctx.drawImage(video, 0, 0, SIZE, SIZE);
  canvas.toBlob(blob => {
    if (!blob) return;

    const fd = new FormData();
    fd.append("image", blob);

    fetch("https://unraided-camren-streamingly.ngrok-free.dev/predict", {
      method: "POST",
      body: fd
    })
    .then(r => r.json())
    .then(data => {
      if (Array.isArray(data.detections)) {
        lastDetections = data.detections;
        lastUpdate = performance.now();
      }
      draw();
    })
    .catch(err => {
      console.error(err);
      draw();
    });
  }, "image/jpeg", 0.9);
}

function draw() {
  ctx.clearRect(0,0,SIZE,SIZE);
  if (performance.now() - lastUpdate > HOLD_TIME) {
    lastDetections = [];
  }

  ctx.strokeStyle = "lime";
  ctx.lineWidth = 2;
  ctx.font = "14px Arial";
  ctx.fillStyle = "lime";

  lastDetections.forEach(d => {
    if (!d.bbox) return;
    const [x1,y1,x2,y2] = d.bbox;
    ctx.strokeRect(x1,y1,x2-x1,y2-y1);
    ctx.fillText(`ID ${d.id}`, x1, y1-5);
  });

  statusText.innerText = `Count: ${lastDetections.length}`;
}
</script>

</body>
</html>
