<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusText = document.getElementById("status");

const SIZE = 416;
let intervalId = null;

async function startLive() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: { ideal: "environment" } }
  });
  video.srcObject = stream;

  video.onloadedmetadata = () => {
    video.width = SIZE;
    video.height = SIZE;
    canvas.width = SIZE;
    canvas.height = SIZE;
    intervalId = setInterval(sendFrame, 300);
    statusText.innerText = "Live";
  };
}

function stopLive() {
  clearInterval(intervalId);
  intervalId = null;
  ctx.clearRect(0,0,SIZE,SIZE);
}

function sendFrame() {
  ctx.drawImage(video, 0, 0, SIZE, SIZE);
  canvas.toBlob(blob => {
    const fd = new FormData();
    fd.append("image", blob);

    fetch("https://unraided-camren-streamingly.ngrok-free.dev/predict", {
      method: "POST",
      body: fd
    })
    .then(r => r.json())
    .then(data => draw(data.detections));
  }, "image/jpeg", 0.9);
}

function draw(dets) {
  ctx.clearRect(0,0,SIZE,SIZE);
  ctx.strokeStyle = "lime";
  ctx.lineWidth = 2;
  ctx.font = "14px Arial";
  ctx.fillStyle = "lime";

  dets.forEach(d => {
    const [x1,y1,x2,y2] = d.bbox;
    ctx.strokeRect(x1,y1,x2-x1,y2-y1);
    ctx.fillText(`ID ${d.id}`, x1, y1-5);
  });

  statusText.innerText = `Count: ${dets.length}`;
}
</script>
